@attribute [Authorize]

<RadzenButton Text="@Title"
              data-testid="cycles_create"
              Disabled="@IsDisabled"
              MouseEnter="@(args => AppTooltipService.ShowTooltip(args, Loc["create.cycles"]))"
              MouseLeave="@AppTooltipService.HideTooltip"
              ButtonStyle="ButtonStyle.Warning" Click="@ShowInlineDialog">
    <RadzenIcon Icon="add"/>
    <RadzenIcon Icon="library_books"/>
</RadzenButton>

@code {
    private Cycles _cycles = new Cycles();
    public DateTime StartDate { get; set; } = DateTime.UtcNow;

    [EditorRequired] [Parameter] public EventCallback OnCycleCreated { get; set; }

    [Parameter] public string Title { get; set; } = string.Empty;

    /// <summary>
    /// Default value is false
    /// </summary>
    [Parameter]
    public bool IsDisabled { get; set; } = false;

    [EditorRequired] [Parameter] public int ProjectId { get; set; }

    private async Task CreateNewCycle()
    {
        var result = await CyclesModel.AddCycle(_cycles, ProjectId);
        DialogService.Close(result);
        StateHasChanged();
        await FormNotificationService.NotifySuccess($"Cycle created successfully with id {_cycles.Id}");

        await OnCycleCreated.InvokeAsync();
    }

    async Task ShowInlineDialog()
    {
        _cycles = new Cycles();
        var result = await DialogService.OpenAsync("Create Cycle", ds =>
            @<RadzenStack Gap="1.5rem" Style="height: 300px;">
                <RadzenTemplateForm Data="_cycles" TItem="Cycles"
                                    Submit="@CreateNewCycle">
                    <ValidationSummary class="alert alert-danger"/>

                    <div class="form-group mb-4">
                        <RadzenLabel Text="Name"/>
                        <RadzenTextBox data-testid="cycle_name"
                                       id="name"
                                       @bind-Value="_cycles.Name"
                                       class="input-style"
                                       Name="name"/>
                        <RadzenRequiredValidator Component="name" Text="Name is required"/>
                    </div>

                    <div class="form-group mb-4">
                        <RadzenLabel Text="Start Date" Component="StartDate"/>
                        <RadzenDatePicker @bind-Value="_cycles.StartDate"
                                          data-testid="cycle_start_date"
                                          Name="StartDate"
                                          DateFormat="yyyy-MM-dd"
                                          Kind="DateTimeKind.Utc"
                                          Change="@OnStartDateChanged"
                                          Style="width:100%;"/>
                        <RadzenRequiredValidator Component="StartDate" Text="Start date is required"/>
                        <RadzenCustomValidator Component="StartDate"
                                               Text="Start date must be earlier than End date"
                                               Validator="@ValidateStartDate"/>
                    </div>

                    <div class="form-group mb-4">
                        <RadzenLabel Text="End Date" Component="EndDate"/>
                        <RadzenDatePicker @bind-Value="_cycles.EndDate"
                                          data-testid="cycle_end_date"
                                          Name="EndDate"
                                          DateFormat="yyyy-MM-dd"
                                          Kind="DateTimeKind.Utc"
                                          Change="@OnEndDateChanged"
                                          Style="width:100%;"/>
                        <RadzenRequiredValidator Component="EndDate" Text="End date is required"/>
                        <RadzenCustomValidator Component="EndDate"
                                               Text="End date must be later than Start date"
                                               Validator="@ValidateEndDate"/>
                    </div>

                    @code{

                        private void OnStartDateChanged(DateTime? selectedDate)
                        {
                            if (!selectedDate.HasValue) return;
                            // Convert local date to UTC
                            _cycles.StartDate = DateTime.SpecifyKind(selectedDate.Value, DateTimeKind.Local).ToUniversalTime();
                        }

                        private void OnEndDateChanged(DateTime? selectedDate)
                        {
                            if (!selectedDate.HasValue) return;
                            // Convert local date to UTC
                            _cycles.EndDate = DateTime.SpecifyKind(selectedDate.Value, DateTimeKind.Local).ToUniversalTime();
                        }

                        bool ValidateStartDate()
                        {
                            return _cycles.StartDate < _cycles.EndDate;
                        }

                        bool ValidateEndDate()
                        {
                            return _cycles.EndDate > _cycles.StartDate;
                        }

                    }

                    <!-- Submit button inside the form -->
                    <RadzenButton Icon="add" Text="Cycle" ButtonStyle="ButtonStyle.Warning"
                                  data-testid="submit_dialog"
                                  ButtonType="ButtonType.Submit"
                                  Style="margin-bottom: 10px;"/>
                </RadzenTemplateForm>
            </RadzenStack>, new DialogOptions() { Draggable = true, CloseDialogOnOverlayClick = true });
    }


}